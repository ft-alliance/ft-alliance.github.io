<!DOCTYPE html>
<html lang="en">
 <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Score Aggregation Demo</title>
    <link href="./css/bootstrap.min.css" rel="stylesheet">
    <script src="./js/vue.js"></script>
    <style type="text/css">
        div.result {
           background-color: #99ddff;
           word-wrap: break-word;
           font-size: 10px;
        }
        .cyphertext {
           word-wrap: break-word;
        }
        .panel {
            padding: 20px;
            border-width: 1px;
            border-style: solid;
            border-radius: 10px;
            border-color: #D3D3D3;
            margin-bottom: 10px;
        }
        .sent {
            color: green;
            font-weight: bold;
        }
        small {
            color: #D3D3D3;
        }
    </style>
</head>
<body>
    <div id="app">
    </div>

    <script type="text/x-template" id="party-template">
        <div class="row panel">
            <div class="col">
                <div class="row">
                    <div class="col">
                        <h3>Party {{party.partyNo}} <small>Enters a score based on their private data</small></h3>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-2">
                        <label class="control-label" for="inputA">Enter score</label>
                    </div>
                    <div class="col-sm-2">
                        <input :disabled="this.sent" v-model="inputValue" type="text" placeholder="Integer">
                    </div>
                    <div class="col-sm-3" v-show="!this.sent">
                        <button type="submit" @click="this.addScoreAndSend" class="btn btn-primary">Add score and send to Party {{nextPartyNo}}</button>
                    </div>
                    <div class="col-sm-3" v-show="!this.sent">
                        <button type="submit" @click="this.addScoreAndReturn" class="btn">Add score and send to Collector</button>
                    </div>
                </div>
                <div class="row" v-show="this.sent">
                    <div class="col-sm-12">
                        <p class="sent">Sent</p>
                        <div class="result"><span class="ciphertext">{{sentText}}</span></div>
                    </div>
                </div>
            </div>
        </div>
    </script>

    <script type="text/x-template" id="main-template">
        <div class="container">
            <div class="row">
                <div class="col">
                    <div class="page-header" style="margin-bottom: 20px">
                        <h1>Score Aggregation Demo <small>using homomorphic encryption</small></h1>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <div class="row panel">
                        <div class="col">
                            <div class="row">
                                <div class="col">
                                    <h3>Collector <small>Initiates the scoring and collects the final result</small></h3>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-2">
                                    <label class="control-label">Enter initial score</label>
                                </div>
                                <div class="col-sm-2">
                                    <input :disabled="initialised" v-model="inputValue" type="text" placeholder="Integer">
                                </div>
                                <div class="col-sm-8">
                                    <button @click="sendInitialScore" class="btn btn-primary">
                                        Encrypt and send to Party 1
                                    </button>
                                </div>
                            </div>
                            <div class="row" v-show="initialised">
                                <div class="col-sm-12">
                                    <p class="sent">Sent</p>
                                    <div class="result"><span class="ciphertext">{{inputEncrypted}}</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <Party :party="party" v-for="party in parties" key="party.partyNo" @send="onSend" v-on:return="onReturn" />

            <div class="row" v-show="this.returnedValue">
                <div class="col">
                    <div class="row panel">
                        <div class="col">
                            <div class="row">
                                <div class="col">
                                    <h3>Collector</h3>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <button type="submit" @click="this.decrypt" class="btn btn-success">Decrypt</button>
                                </div>
                            </div>
                            <div class="row" v-show="plainText" style="padding-top:20px">
                                <div class="col-sm-2">
                                    <label class="control-label">Decrypted score</label>
                                </div>
                                <div class="col-sm-2">
                                    <input disabled :value="this.plainText" type="text" placeholder="Integer">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </script>

    <script src="./js/jquery.js"></script>
    <script src="./js/bootstrap.min.js"></script>
    <script type="text/javascript" src="./js/jsbn.js"></script>
    <script type="text/javascript" src="./js/jsbn2.js"></script>
    <script type="text/javascript" src="./js/prng4.js"></script>
    <script type="text/javascript" src="./js/rng.js"></script>
    <script type="text/javascript" src="./js/paillier.js"></script>


    <script type="text/javascript">
     var keys;

     keys = paillier.generateKeys(1024);

     Vue.component('Party', {
         template: '#party-template',
         props: ['party'],
         data () {
             return {
                 inputValue: this.party.inputValue,
                 sent: false
             }
         },
         mounted () {
            console.log(this.party)
         },
        methods: {
            addScore () {
                 var encrypted = keys.pub.encrypt(nbv(parseInt(this.inputValue)))
                 var added = keys.pub.add(this.party.received, encrypted);
                 this.party.inputValue = this.inputValue
                 this.party.sent = added
             },
             addScoreAndSend () {
                this.addScore()
                this.$emit('send', this.party)
                this.sent = true
             },
             addScoreAndReturn () {
                this.addScore()
                this.$emit('return', this.party)
                this.sent = true
             }
         },
         computed: {
            nextPartyNo () {
                return this.party.partyNo + 1
            },
            sentText () {
                return this.party.sent ? this.party.sent.toString() : ""
            }
         }
     })

     var vm = new Vue({
         el: '#app',
         template: '#main-template',
         data: {
             initialised: false,
             inputValue: null,
             inputEncrypted: null,
             returnedValue: null,
             parties: [],
             currentParty: 0,
             plainText: null
         },
         methods: {
             sendInitialScore () {
                console.log(parseInt(this.inputValue))
                 var enc = keys.pub.encrypt(nbv(parseInt(this.inputValue)))
                 // Store the string representation for display
                 this.inputEncrypted  = enc.toString()
                 console.log('initialScore')
                 console.log(enc)
                 this.sendToNextParty(enc)
                 this.initialised = true
             },
             sendToNextParty (received) {
                console.log('sendToNextParty')
                console.log(received)
                this.currentParty = this.currentParty + 1
                 var party =  {
                     partyNo: this.currentParty,
                     received: received,
                     inputValue: null,
                     sent: null
                 }
                 this.parties.push(party)
             },
             onSend (party) {
                console.log('onSend')
                console.log(party)
                this.parties[party.partyNo - 1] = party
                console.log(this.parties)
                this.sendToNextParty(party.sent)
             },
             onReturn (party) {
                console.log('onReturn')
                console.log(party)
                this.parties[party.partyNo - 1] = party
                this.returnedValue = party.sent
                console.log(this.returnedValue)
             },
             decrypt () {
                 this.plainText = keys.sec.decrypt(this.returnedValue).toString(10)
             }
         }
     })
    </script>

</body>
</html>
